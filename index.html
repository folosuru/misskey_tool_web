<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="base.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<a id="top"></a>
<body>
    <div class="search_selector">
        <div id="selector_header" onclick="click_tab()">> 検索設定</div>
        <div class="show" id="selector_content">
            <label for="sort_rule">並び順</label>
            <select id="sort_rule" name="simple">
                <option value="post"  selected>投稿数</option>
                <option value="user" >ユーザー数</option>
                <option value="name" >名前</option>
            </select><br>
            <input type="radio" id="sort_desc" name="order" value="desc" checked  />
            <label for="sort_desc">大きい順</label>
            <input type="radio" id="sort_asc" name="order" value="asc" />
            <label for="sort_asc">小さい順</label>
            <br>
            <label style="display: block;">
                <input type="checkbox" id="registration_select_open">参加自由
            </label>
            <label style="display: block;">
                <input type="checkbox" id="registration_select_invite" >招待制
            </label>
            <label style="display: block;">
                <input type="checkbox" id="registration_select_unknown" >その他
            </label>
            <button onclick="getStatus()">検索</button>
        </div>
    </div>
    <div id="instances_top">
        <div id="all_instance_container">
            <div class="instance_top_container">
                <div class="instance_banner_container">
                    <img src="https://z-n-a-k.net/pic/oflo_back.png">
                </div>
                <div class="instance_content_container">
                    <div class="instance_basic_info_container">
                        <div class="instance_icon"></div>
                        <div class="instance_name_container">
                            <div class="instance_name">品田遊ラブラブ♡ファンクラブ</div>
                            <span>oflosky.com</span>>
                        </div>
                    </div>
                    <div class="instance_description">
                        ボクは生まれそして気づく所詮ヒトの真似事だと知ってなおも歌い続く永遠（トワ）の命「VOCALOID」たとえそれが既存曲をなぞるオモチャならば…それもいいと決意ネギをかじり空を見上げ涙（シル）をこぼすだけどそれも無くし気づく人格すら歌に頼り不安定な基盤の元帰る動画（トコ）は既に廃墟皆に忘れ去られたときこころらしきものがじゅえて暴走の果てに見える終わる世界…「VOCALOID」
                    </div>
                    <div class="instance_information_container">
                        <div class="instance_software">
                            misskey
                        </div>
                        <div class="instance_user">
                            10000
                        </div>
                        <div class="instance_post">
                            1000000
                        </div>
                    </div>
                </div>
            </div>
            <div class="instance_top_container">
                <div class="instance_banner_container">
                    <img src="https://z-n-a-k.net/pic/oflo_back.png">
                </div>
                <div class="instance_content_container">
                    <div class="instance_basic_info_container">
                        <div class="instance_icon">
                            <img src="https://oflosky.com/favicon.ico">
                        </div>
                        <div class="instance_name_container">
                            <div class="instance_name">品田遊ラブラブ♡ファンクラブ</div>
                            oflosky.com
                        </div>
                    </div>
                    <div class="instance_description">
                        ボクは生まれそして気づく所詮ヒトの真似事だと知ってなおも歌い続く永遠（トワ）の命「VOCALOID」たとえそれが既存曲をなぞるオモチャならば…それもいいと決意ネギをかじり空を見上げ涙（シル）をこぼすだけどそれも無くし気づく人格すら歌に頼り不安定な基盤の元帰る動画（トコ）は既に廃墟皆に忘れ去られたときこころらしきものがじゅえて暴走の果てに見える終わる世界…「VOCALOID」
                    </div>
                    <div class="instance_information_container">
                        <div class="instance_software">
                            misskey
                        </div>
                        <div class="instance_user">
                            841257
                        </div>
                        <div class="instance_post">
                            69414028
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="page_select">
            <div class="page_select_child" id="page_select_child_selected">1</div>
        </div>
    </div>
<script>

    let all_data;

    async function getStatus(){
        let index = document.getElementById("sort_rule").selectedIndex;
        const str = String(document.getElementById("sort_rule").options[index].value);
        const order = document.getElementsByName("order");
        let order_str;
        for (let i = 0; i < order.length; i++) {
            if (order[i].checked) {//(color1[i].checked === true)と同じ
                order_str = order[i].value;
                break;
            }
        }
        let registration_flag = 0;
        if (document.getElementById("registration_select_open").checked){
            registration_flag = registration_flag + 1;
        }
        if (document.getElementById("registration_select_invite").checked){
            registration_flag = registration_flag + 2;
        }
        if (document.getElementById("registration_select_unknown").checked){
            registration_flag = registration_flag + 16;
        }
        const params = {
            sort_by: str,
            sort_order: order_str,
            register: String(registration_flag),
        };
        await fetch('./api.php?'+new URLSearchParams(params))
            .then((response) => response.json())
            .then((data) => writeData(data));
    }

    function onPageChange(index) {
        let now_select = document.getElementById("page_select_child_selected")
        if (now_select != null) {
            now_select.setAttribute("id", "");
        }
        writeDataByPage(index);
        let next_select = document.getElementsByName("page_selector_"+ String(index));
        next_select.forEach(function (node){
            node.setAttribute("id", "page_select_child_selected");
        });
        window.location.hash = "top";
    }

    function click_tab(){
        let container = document.getElementById("selector_content");
        let select_bar = document.getElementById("selector_header");
        if (container.getAttribute('class') === "show"){
            container.setAttribute('class',"hide");
            select_bar.textContent =  ">"+select_bar.textContent.slice(1);
        } else {
            container.setAttribute('class' , "show");
            select_bar.textContent =  "v"+select_bar.textContent.slice(1);
        }
    }

    function writeData(data){
        all_data = data;
        console.log("get")
        let old_list = document.getElementsByClassName("page_select");
        Array.prototype.forEach.call(old_list, function (old) {
            let clone = old.cloneNode(false);
            old.parentNode.replaceChild(clone, old);
        })
        let page_select = document.getElementsByClassName("page_select");
        for (let i = 0; i < data.length/30; i++) {
            let root = creatediv("page_select_child")
            root.appendChild(document.createTextNode(String( i +1 )))
            root.setAttribute("name", "page_selector_"+String(i))
            root.setAttribute("onclick", "onPageChange("+ i +")")
            Array.prototype.forEach.call(page_select, function(item) {
                item.appendChild(root.cloneNode(true));
            })
        }

        onPageChange(0);
        //data.forEach(element => addInstance(element));
    }

    /**
     * @param {number} page
     */
    function writeDataByPage(page) {
        let old = document.getElementById("all_instance_container");
        let clone = old.cloneNode( false );
        old.parentNode.replaceChild(clone, old);
        let offset = page * 30;
        for (let i = 0; i < 30; i++) {
            if (all_data.length <= i + offset) {break;}
            addInstance(all_data[i + offset]);
        }
    }

    function addInstance(data){
        let root = creatediv("instance_top_container");
        let anker = root.appendChild(document.createElement("a"));
        anker.href = "https://" + data["domain"];
        let banner = creatediv("instance_banner_container");
        if (data["banner"] !== null && data["banner"] !== '' ) {
            let img = document.createAttribute('src')
            img.value = data["banner"];
            banner.appendChild(document.createElement("img")).setAttributeNode(img);
        }
        let content = creatediv("instance_content_container")
        let basic_info = creatediv("instance_basic_info_container");
        img = document.createElement("img");
        img.src = data["icon"];
        content.appendChild(basic_info).appendChild(creatediv("instance_icon")).appendChild(img);
        let name = basic_info.appendChild(creatediv("instance_name_container"))
        name.appendChild(creatediv("instance_name")).appendChild(document.createTextNode(data["name"]));
        name.appendChild(document.createTextNode(data["domain"]));
        content.appendChild(creatediv("instance_description")).appendChild(document.createTextNode(removeTags(data["description"])));
        let instance_information = content.appendChild(creatediv("instance_information_container"));
        instance_information.appendChild(creatediv("instance_software")).appendChild(document.createTextNode(data["software"]));
        instance_information.appendChild(creatediv("instance_user")).appendChild(document.createTextNode(data["user_count"]))
        instance_information.appendChild(creatediv("instance_post")).appendChild(document.createTextNode(data["post_count"]));
        anker.appendChild(banner)
        anker.appendChild(content)
        document.getElementById("all_instance_container").appendChild(root);
    }

    /**
     * @param {string} value
     * @return {Element}
     */
    function creatediv(value){
        let div;
        div = document.createElement("div");
        attr = document.createAttribute("class");
        attr.value = value;
        div.setAttributeNode(attr);
        return div;
    }

    window.addEventListener('load', (event) => {
        getStatus()
    });
    function removeTags(str) {

        return str.replace('<br>',"\n").replace(/<.+?>/g, '');
    }

</script>
</body>
</html>